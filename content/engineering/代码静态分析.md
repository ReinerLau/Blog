---
title: 代码静态分析
tags:
  - 工程化
---
## 为什么需要代码静态分析?

常见的非 JavaScript 服务端语言在运行前都有一个编译的过程，在这个编译的过程中会自动检查语法和类型错误

而原生 JavaScript 在运行前不需要编译的过程，只有在浏览器运行时才能发现错误警告，这样就没办法在开发阶段及时发现问题并解决

所以静态分析指的就是在不执行代码的情况下，对代码进行自动化的检查和分析，比如语法错误

## ESLint

前端最常见的静态分析工具

### 基本用法

安装

```shell
pnpm add --save-dev eslint@8
```

::: tip
值得注意的是，eslint 的最新版本为 9，从配置上和 8 有很大区别，这里用 8 演示
:::

配置脚本

```json
{
	"scripts": {
		"lint": "eslint --fix"
	}
}
```

执行一下命令就会自动检查目录下所有 js 代码

```shell
pnpm lint
```

在 `.eslintrc.cjs` 文件中对 eslint 进行配置（也可以使用其他格式配置文件，参考官方文档）

```js
module.exports = {
  env: {
	  browser: true,
	  es6: true
  },
  root: true,
  extends: "eslint:recommended",
};
```


### 配置

- env:  配置 eslint 检查时涉及到的运行环境，防止不认识特定环境下才有的全局变量
- root: 标记了 eslint 搜索配置时的停止点，eslint 检查某个文件时优先使用最近的配置文件，再向上一层搜索，同时会合并途中找到的所有配置文件，直到到达带有 `root: true` 的配置文件或根目录
- extends: 
    - 用于使用预设的配置，不需要手动配置，
    - 使用带有 `eslint-config-` 前缀的 npm 包时，可以省略前缀，
    - 有两个自带的预设  `eslint:recommended` 和 `eslint:all` 
- plugins:
    - 拓展非 JavaScript 语法的自定义规则
    - 自带预设配置，通过 `plugin:` 前缀使用
    - 使用时可以省略 `eslint-plugin-` 前缀
- parser: eslint 校验代码前默认使用 `Espree` 解析器将 JavaScript 语法转换成 AST 后再进行校验，对于其他语法默认解析不了，因此需要其他解析器帮助

### 兼容 TypeScript

安装依赖

```shell
pnpm add --save-dev @typescript-eslint/eslint-plugin @typescript-eslint/parser
```

配置

```js
module.exports = {
  parser: "@typescript-eslint/parser",
  extends: ["plugin:@typescript-eslint/recommended"],
  plugins: ["@typescript-eslint"],
};
```

### 兼容 Vue

安装依赖

```shell
pnpm add --save-dev eslint-plugin-vue
```

配置

```ts
module.exports = {
  parser: "vue-eslint-parser",
  parserOptions: {
    parser: "@typescript-eslint/parser",
  },
  extends: [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:vue/vue3-recommended",
  ],
  plugins: ["@typescript-eslint", "vue"],
};
```

### VSCode 插件

[插件](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)可以自动读取配置文件，实现主要的两个功能：

- 对文件进行错误高亮
- 保存后自动修复错误

`.vscode/setting.json`

```json
{
	"editor.codeActionsOnSave": {
		"source.fixAll.eslint": "explicit"
	}
}
```

## 故障排除

>  `.eslintrc.cjs` 中 `module` 语法报错

因为 `eslint` 不确定当前文件的运行环境，`.eslintrc.cjs` 应该在 `node` 环境下被读取，所以对该文件指定环境为 `node` 环境，配置文件顶部加上这句

```js
/* eslint-env node */
```

> 为什么没有配置 `@typescript-eslint/parser` 的情况下也能校验 ts 语法？

可能是 `ts` 代码过于简单，导致使用默认解析器解析出来的内容和 `js` 类似？不过不配置预设的情况下，肯定校验不了，这时候就一定要加上 `@typescript-eslint/parser` 解析器
